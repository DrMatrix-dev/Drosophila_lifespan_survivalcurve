# Drosophila Lifespan Survival Analysis Tool

## 项目简介
专业的果蝇生存曲线分析工具，支持从基础分析到高级统计的完整工作流。

## 📊 功能特性

- **自动化数据处理**：自动识别Excel文件中的有效数据表
- **性别检测**：智能检测实验数据的性别信息（♂/♀或male/female），目前有一点bug，之后会修复
- **分组统计**：自动识别实验分组结构
- **生存率计算**：基于实验数据计算生存率和标准误差
- **可视化图表**：绘制美观的生存曲线图，包含误差线
- **logrank检验分析**：可以将当前数据转化为个体数据，进行logrank检验并输出p值，保存在文件中
- **统计结果保存**：保存分组生存率数据，并将每组平均值和标准误高亮显示
- **多格式支持**：目前仅支持.xlsx，后续将补充.xls和.csv格式数据

## 项目结构
dev/
├── 1.0/ # v1.0.0 初始功能版
├── 2.0/ # v2.x 算法优化系列
│ ├── 2.0.0/ # v2.0.0 bug修复版
│ ├── 2.1.0/ # v2.1.0 显示优化版
│ └── 2.2.0/ # v2.2.0 完善版
├── 3.0/ # v3.x 模块化系列
│ ├── 3.0.0/ # v3.0.0 架构重构
│ ├── 3.1.0/ # v3.1.0 统计分析
│ └── 3.2.0/ # v3.2.0 开发中
└── demo/ # demo 演示版（最早）

## 🛠️ 系统架构

### 1. 数据模型层 (Model)
- `ExcelFileData`: Excel文件数据模型
- `SheetAnalysisData`: Sheet分析数据模型

### 2. 数据访问层 (Data Access)
- `FileIO`: 读取实验数据和写入分析结果

### 3. 业务逻辑层 (Business Logic)
- `GenderDetector`: 性别检测器
- `ExcelDataPreprocessor`: Excel数据预处理器
- `SurvivalCalculator`: 生存率计算器
- `SurvivalStatistics`: logrank检验模块

### 4. 展示层 (Presentation)
- `PlotDataPreparer`: 绘图数据准备器
- `PlotStyleConfigurator`: 绘图样式配置器
- `SurvivalCurvePlotter`: 生存曲线绘图器

### 5. 服务层 (Service)
- `SurvivalAnalysisService`: 生存分析服务

### 6. 应用层 (Application)
- `SurvivalAnalysisApp`: 主应用程序

## 版本演进
1. demo: 最早的效果展示版
2. v1.0.0: 初始功能完整版
3. v2.0.0: 修复性别检测bug，增加路径清理
4. v2.1.0: 图表显示优化
5. v2.2.0: 功能完善稳定版
6. v3.0.0: 模块化架构重构
7. v3.1.0: 统计分析功能
8. v3.2.0: 新功能开发中

## 📋 数据格式要求

### Excel文件结构（以test.xlsx为例）：
- **大分组标识**：有内容开始第一行包含大分组信息（如A、B、C，分为对照组、实验组…）
- **实验序号与类型标识**：第二行检验分组group_type：区分是对照组还是实验组，分别用exp1_con和exp1_treat1表示。
如果有出现多个对照-实验对，则用 exp序号_con 和 exp序号_treat序号 进行区分。exp表示哪个实验，下划线后表示对照/干预组别。
- **重复组标识**：第三行包含各大分组内重复组标签（1,2,3,4…）
- **实验数据**：第四行开始，包含：
  - 日期列（Date），表示记录数据的日期。必须包含，但可以随便填写，不作为作图数据使用。
  - 天数列（Days），表示从开始诱导到第几天的数据。
  - 各分组在各时间点的生存数据（负值表示死亡数量，数据类型应为数值。一定注意不能有多余空格，尤其注意检查无数据区块是否有多余空格，否则将导致识别异常报错）

- **具体起始位置无需精确要求，程序会自动去除空行列，仅需保证表格格式和样例一致。**

### 示例数据格式：
```
第1行 | female         |      | A           |    |    |    | B           |    | ...
第2行 | group_type     |      | exp1_treat1 |    |    |    | exp1_treat2 |    | ...
第3行 | Date           | Days | 1           | 2  | 3  | 4  | 1           | 2  | ...
第4行 | 2025-12-07     | 0    |             |    |    |    |             |    | ...
第5行 | 2025-12-09     | 2    |             |    |    |    |             |    | ...
...
第n行 | 2025-12-31     | 24   | -1          | -4 | -1 | -2 |             |    | ...

## 📈 输出结果

程序将自动生成生存曲线图，包含以下信息：
- 各分组的生存曲线
- 误差线（标准误差）
- 图表标题（包含sheet名称和检测到的性别）
- 文件信息注释

程序将把每组生存率、标准误、logrank检验结果表格输出到输入文件同目录下

## 快速开始
```bash
# 使用稳定版
cd 3.0/3.1.0/
python main.py

# 使用开发版
cd 3.0/3.2.0/
python main.py

# 依赖
pip install -r requirements.txt

**版本**: 3.1.0  Release version
**最后更新**: 2026年2月8日  
**兼容性**: Python 3.11
